<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-icons/communication-icons.html">
<link rel="import" href="../../bower_components/iron-icons/device-icons.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../bower_components/iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../../bower_components/iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../../bower_components/iron-dropdown/iron-dropdown.html">
<link rel="import" href="../../bower_components/iron-overlay-behavior/iron-overlay-behavior.html">


<link rel="import" href="../behaviors/ajax-behavior.html">
<link rel="import" href="../behaviors/dates-behavior.html">
<link rel="import" href="../behaviors/utils-behavior.html">
<link rel="import" href="../behaviors/settings-behavior.html">

<link rel="import" href="../shared-styles.html">

<script src="../../bower_components/moment/min/moment.min.js"></script>

<link rel="import" href="../custom-components/appline-idfiscal-input/appline-idfiscal-input.html">
<link rel="import" href="../custom-components/appline-auth-panel/appline-login-form.html">
<link rel="import" href="../custom-components/appline-auth-panel/appline-auth-panel.html">
<link rel="import" href="../custom-components/appline-wait/appline-wait.html">
<link rel="import" href="../custom-components/appline-error-msg/appline-error-msg.html">
<link rel="import" href="../custom-components/trineo-busca-xrz/trineo-busca-xrz.html">
<link rel="import" href="../custom-components/trineo-combinacion-fiscal/trineo-combinacion-fiscal.html">
<link rel="import" href="../custom-components/trineo-list/trineo-list.html">
<link rel="import" href="../custom-components/trineo-decimal-input/trineo-decimal-input.html">

<dom-module id="trineo-core">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      
      :host {
        display: block;
      }

    </style>

    <appline-wait id="wait"></appline-wait>

    <appline-auth-panel id="auth" logged-in="{{userLoggedIn}}" user-backend="{{userBackend}}"></appline-auth-panel>

    <iron-pages selected="[[page]]" attr-for-selected="name">
      <appline-login-form name="login" user-backend="{{userBackend}}" login-url="[[apiUrl]]/utils/login/" create-url="[[apiUrl]]/utils/create-user/" id="loginForm"></appline-login-form>
      <trineo-app id="app" user-backend="{{userBackend}}" name="app"></trineo-app>
    </iron-pages>

    
    <paper-dialog id="confini" modal>
      <h2>Como delegar "Factura Electrónica" en AFIP</h2>
      <paper-dialog-scrollable>
        <p>Para poder usar facturofacil es necesario declarar su uso en la AFIP. Para ello se deben seguir los siguientes pasos:</p>        
        <ol type="1">
            <li><p>Dirigase a la página de <a href="https://www.afip.gob.ar/" target="_blank">AFIP</a> y registrese con su CUIT y clave fiscal.</p></li>
            <li>
                <p>Seleccione "Administrador de Relaciones de Clave Fiscal</p>
                <img width="600px" src="../../images/confini/afip002.png" alt="Afip Relaciones Clave Fiscal">
            </li>
            <li>
                <p>En la pagina "Administrador de Relaciones" haga click en el boton "Nueva Relacion"</p>
                <img width="600px" src="../../images/confini/afip003.png" alt="Nueva Relacion">
            </li>
            <li>
                <p>Haga click en el boton "Buscar" para seleccionar el servicio que va a relacionar (Facturación Electrónica)</p>
                <img width="600px" src="../../images/confini/afip004.jpg" alt="Boton buscar">
            </li>
            <li>
                <p>En la lista desplegada vaya a AFIP -> Web Services y haga click sobre "Facturación Electrónica"</p>
            </li>
            <li>
                <p>Una vez seleccionado "Facturación Electrónica" volverá al "Administrador de Relaciones" y ahi deberá elegir el representante haciendo click en el boton "Buscar"</p>
                <img width="600px" src="../../images/confini/afip007.jpg" alt="Representante">
            </li>
            <li>
                <p>Ingrese el CUIT 20318638803. Y haga click en "Confirmar"</p>
                <img width="600px" src="../../images/confini/afip008.jpg" alt="Representante Confirmar">
            </li>
            <li>
                <p>De vuelta en "Administrador de Relaciones" queda hacer click en "Confirmar" para terminar la delegación.</p>
                <img width="600px" src="../../images/confini/afip009.jpg" alt="Representante Confirmar">
            </li>
            <li>
                <p>Imprima el comprobante de autorización. Y salga de la página de AFIP.</p>
            </li>
            <li>
                <p>Por ultimo debe notificarnos del inicio del trámite para que podamos confirmarlo y permitir el uso del sistema. Para ello haga click en "NOTIFICAR".</p>
            </li>
        </ol>
      </paper-dialog-scrollable>
      <div class="buttons"><paper-button raised dialog-dismiss autofocus>Aceptar</paper-button></div>
    </paper-dialog>
    
    
  </template>

  <script>
    Polymer({
      is: 'trineo-core',

      properties: {
        page: String,
        userBackend: Object,
        userLoggedIn: {
          type: Boolean,
          observer: "_userLoggedInChanged"
        }
      },

      ready: function() {
        //Cuando termina de cargar este componente, carga el otro (app) mientras el usuario se loguea
        var resolvedPageUrl = this.resolveUrl('../trineo-app/trineo-app.html');
        this.importHref(resolvedPageUrl, null, null, true);
      },

      behaviors: [AjaxBehavior],

      listeners: {
        "open-wait": "_lanzarWaitDialog",
        "close-wait": "_cerrarWaitDialog",
        "logout": "_logout",
        "comprobante-no-aprobado": "_mostrarError",
        "error-general": "_mostrarErrorGeneral",
        "trineo-buscarxrz": "_lanzarDialogBuscarXRZ",
        "trineo-busca-xrz-contribuyente-selected": "_onContribuyentePadronSelected",
        "trineo-cliente-form": "_lanzarTrineoClienteForm", //Es Dialog, todos los dialog se lanzan de aca
        "trineo-cliente-form-ok": "_clienteChangedOK",
        "trineo-proveedor-form-ok": "_proveedorChangedOK",
        "trineo-factv-cliente-no-encontrado": "_onFactvClienteNoEncontrado",
        "trineo-factv-cuit-no-encontrado": "_onFactvCuitNoEncontrado",
        "trineo-settings-info-delegacion": "_openInfoDelegacion",
        "trineo-articulo-form": "_lanzarTrineoArticuloForm", //Es Dialog, todos los dialog se lanzan de aca
        "trineo-articulo-form-ok": "_articuloFormOK",
        "trineo-linea-form": "_lanzarTrineoLineaForm", //Es Dialog, todos los dialog se lanzan de aca
        "trineo-linea-form-ok": "_lineaFormOK",
        "trineo-rubro-form": "_lanzarTrineoRubroForm", //Es Dialog, todos los dialog se lanzan de aca
        "trineo-rubro-form-ok": "_rubroFormOK",
        "trineo-subrubro-form": "_lanzarTrineoSubrubroForm", //Es Dialog, todos los dialog se lanzan de aca
        "trineo-subrubro-form-ok": "_subrubroFormOK"
      },

      _userLoggedInChanged: function(val) {
        if (val==true) {
          this.page="app"
        }
        else {
          this.page="login"
        }
      },

      _logout: function() {
        this.set('userBackend', undefined)
      },

      
      _lanzarWaitDialog: function(e) {
        this.$.wait.mensaje=e.detail.mensaje
        this.$.wait.open()
      },

      _cerrarWaitDialog: function(e) {
        this.$.wait.close()
      },

      _mostrarError: function(e) {
        var err = e.detail.data.err
        var obs = e.detail.data.obs
        var d = document.createElement("paper-dialog")
        Polymer.dom(d).setAttribute('id','error-comprobante-dialog')
        Polymer.dom(d).setAttribute('modal',true)
        Polymer.dom(this.root).appendChild(d)
        Polymer.dom(d).innerHTML+="<h1>Comprobante Rechazado</h1>"
        if (err) {
          Polymer.dom(d).innerHTML+="<ul></ul>"
          var ul = Polymer.dom(d).querySelector("ul")
          for (i=0;i<err.length;i++) {
            Polymer.dom(ul).innerHTML="<li>"+err[i].code + " - " + err[i].msg + "</li>"
          }
        }
        Polymer.dom(d).innerHTML+='<div class="buttons"><paper-button raised dialog-dismiss autofocus>Aceptar</paper-button></div>'
        d.open()
      },

      _mostrarErrorGeneral: function(e) {
        var d = document.createElement("paper-dialog")
        Polymer.dom(d).setAttribute('id','error-general-dialog')
        Polymer.dom(d).setAttribute('modal',true)
        Polymer.dom(this.root).appendChild(d)
        Polymer.dom(d).innerHTML+="<h1>Ups! Error General</h1><p>Hay problemas en los servidores de Appline. Reintente en unos minutos sino comuniquese con nosotros al 03562-401277.</p>"
        Polymer.dom(d).innerHTML+='<div class="buttons"><paper-button raised dialog-dismiss autofocus>Aceptar</paper-button></div>'
        d.open()
      },

      _lanzarDialogBuscarXRZ: function(e) {
        var d = document.createElement('trineo-busca-xrz');
        d.origen = e.detail.origen
        Polymer.dom(this.root).appendChild(d);
        d.open();
      },

      _onContribuyentePadronSelected: function(e) {
        if (e.detail.origen==0) {
          this.$.app.$.factv.$.form.set("cliente", e.detail.contribuyente)
        }
        else if (e.detail.origen == 1) {
          var d = document.createElement('trineo-cliente-form');
          d.accion = 0
          d.set("cliente", e.detail.contribuyente)
          Polymer.dom(this.root).appendChild(d);
          var that = this
          d.addEventListener('trineo-cliente-form-ok', function(e){
            Polymer.dom(that.root).removeChild(d);
          });
          d.open();
        }
        else if (e.detail.origen == 2) {
          var d = document.createElement('trineo-proveedor-form');
          d.accion = 0
          d.set("proveedor", e.detail.contribuyente)
          Polymer.dom(this.root).appendChild(d);
          var that = this
          d.open();
        }
        
      },

      _lanzarTrineoClienteForm: function(e) {
        //HTML Ya fue importado cuando se cargo la lista de clientes
        var d = document.createElement('trineo-cliente-form');
        if (e.detail.accion==0) {//nuevo
          d.accion=0;
        }
        else {
          d.set("cliente", e.detail.cliente);
          d.accion=1;
        }
        Polymer.dom(this.root).appendChild(d);
        var that = this
        d.addEventListener('trineo-cliente-form-ok', function(e){
          Polymer.dom(that.root).removeChild(d);
        });
        d.open();
      },

      _clienteChangedOK: function(e) {
        var t = document.createElement("paper-toast")
        if (e.detail.accion==1) {t.text="Cliente Modificado"}
        else {t.text="Cliente Agregado"}
        Polymer.dom(this.root).appendChild(t);
        this.$.app.$.clientes.$.cligrid.refreshItems();
        t.open();
      },

      _onFactvClienteNoEncontrado: function(e) {
        var t = document.createElement("paper-toast")
        t.text="Cliente no encontrado. Cargue los datos"
        Polymer.dom(this.root).appendChild(t);
        t.open();
      },
      
      _onFactvCuitNoEncontrado: function(e) {
        var t = document.createElement("paper-toast")
        t.text="Cuit no encontrado en AFIP"
        Polymer.dom(this.root).appendChild(t);
        t.open();
      },

      _openInfoDelegacion: function() {
        this.$.confini.open();
      },

      _lanzarTrineoArticuloForm: function(e) {
        //HTML Ya fue importado cuando se cargo la lista de clientes
        var d = document.createElement('trineo-articulo-form');
        if (e.detail.accion==0) {//nuevo
          d.accion=0;
        }
        else {
          d.set("articulo", e.detail.articulo);
          d.accion=1;
        }
        Polymer.dom(this.root).appendChild(d);
        var that = this
        d.addEventListener('trineo-articulo-form-ok', function(e){
          Polymer.dom(that.root).removeChild(d);
        });
        d.open();
      },

      _articuloFormOK: function(e) {
        var t = document.createElement("paper-toast")
        if (e.detail.accion==1) {t.text="Articulo Modificado"}
        else {t.text="Articulo Agregado"}
        Polymer.dom(this.root).appendChild(t);
        this.$.app.$.articulos.$.artgrid.refreshItems();
        t.open();
      },

      _lanzarTrineoLineaForm: function(e) {
        //HTML Ya fue importado cuando se cargo la lista de clientes
        var d = document.createElement('trineo-linea-form');
        if (e.detail.accion==0) {//nuevo
          d.accion=0;
        }
        else {
          d.set("linea", e.detail.linea);
          d.accion=1;
        }
        Polymer.dom(this.root).appendChild(d);
        var that = this
        d.addEventListener('trineo-linea-form-ok', function(e){
          Polymer.dom(that.root).removeChild(d);
        });
        d.open();
      },

      _lineaFormOK: function(e) {
        var t = document.createElement("paper-toast")
        if (e.detail.accion==1) {t.text="Linea Modificada"}
        else {t.text="Linea Creada"}
        Polymer.dom(this.root).appendChild(t);
        this.$.app.$.lineas.$.lingrid.refreshItems();
        t.open();
      },

      _lanzarTrineoRubroForm: function(e) {
        //HTML Ya fue importado cuando se cargo la lista de clientes
        var d = document.createElement('trineo-rubro-form');
        if (e.detail.accion==0) {//nuevo
          d.accion=0;
        }
        else {
          d.set("rubro", e.detail.rubro);
          d.accion=1;
        }
        Polymer.dom(this.root).appendChild(d);
        var that = this
        d.addEventListener('trineo-rubro-form-ok', function(e){
          Polymer.dom(that.root).removeChild(d);
        });
        d.open();
      },

      _rubroFormOK: function(e) {
        var t = document.createElement("paper-toast")
        if (e.detail.accion==1) {t.text="Rubro Modificado"}
        else {t.text="Rubro Creado"}
        Polymer.dom(this.root).appendChild(t);
        this.$.app.$.rubros.$.rubgrid.refreshItems();
        t.open();
      },

      _lanzarTrineoSubrubroForm: function(e) {
        //HTML Ya fue importado cuando se cargo la lista de clientes
        var d = document.createElement('trineo-subrubro-form');
        if (e.detail.accion==0) {//nuevo
          d.accion=0;
        }
        else {
          d.set("subrubro", e.detail.subrubro);
          d.accion=1;
        }
        Polymer.dom(this.root).appendChild(d);
        var that = this
        d.addEventListener('trineo-subrubro-form-ok', function(e){
          Polymer.dom(that.root).removeChild(d);
        });
        d.open();
      },

      _subrubroFormOK: function(e) {
        var t = document.createElement("paper-toast")
        if (e.detail.accion==1) {t.text="Subrubro Modificado"}
        else {t.text="Subrubro Creado"}
        Polymer.dom(this.root).appendChild(t);
        this.$.app.$.subrubros.$.subgrid.refreshItems();
        t.open();
      },

      _proveedorChangedOK: function(e) {
        var t = document.createElement("paper-toast")
        if (e.detail.accion==1) {t.text="Proveedor Modificado"}
        else {t.text="Proveedor Agregado"}
        Polymer.dom(this.root).appendChild(t);
        this.$.app.$.proveedores.$.proveedoresList.refreshItems();
        t.open();
      },
      
    });
  </script>
</dom-module>