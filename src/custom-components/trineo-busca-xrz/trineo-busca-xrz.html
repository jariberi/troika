<dom-module id="trineo-busca-xrz">
    <template>
        <style include="iron-flex iron-flex-alignment">
            :host {
                display: block;
            }
            paper-dialog {
                width: 65vw;
                height: 60vh;
            }

            div.buttons {
                position: absolute !important;
                bottom: 0 !important;
                right: 0 !important;   
            }

            vaadin-grid {
                max-height: 60%;
            }
        </style>
        
        <paper-dialog id="dialog" modal>
            <h2>Búsqueda en Padrón de AFIP</h2>
            
            <div class="layout horizontal center">
            <paper-input label="Razon Social" on-keydown="_search" id="rzsearch" class="flex"></paper-input>
            <p>Presione ENTER para buscar</p>
            </div>
            <appline-error-msg>ERROR!</appline-error-msg>
            <vaadin-grid id="table">
                <table>
                    <colgroup>
                        <col name="cuit">
                        <col name="razon_social">
                        <col name="direccion">
                        <col name="localidad">
                        <col name="cond_iva_display">
                    </colgroup>
                </table>
            </vaadin-grid>
            <div class="buttons">
                <paper-button raised dialog-dismiss autofocus>Cancelar</paper-button>
                <paper-button raised dialog-dismiss on-tap="_clienteSelected" disabled="[[_nothingSelected]]">Aceptar</paper-button>
            </div>
        </paper-dialog>
        
    </template>
    <script>
        Polymer({
            is: 'trineo-busca-xrz',

            ready: function() {
                
                
            },

            behaviors: [AjaxBehavior],

            properties: {
                token: String,
                _nothingSelected: {
                    type: Boolean,
                    value: true
                    }
            },

            listeners: {
                "selected-items-changed": '_onSelectedItemsChanged'
            },

            _onSelectedItemsChanged: function(e) {
                if (this.$.table.selection.size == 0) {
                    this._nothingSelected = true
                }
                else {
                    this._nothingSelected = false
                }
            },

            _search: function(e) {
                if (e.keyCode==13) {
                    var val = this.$.rzsearch.value
                    if (val.length > 5) {
                        this.$.table.items = []
                        this.$.table.size = 30
                        var that = this
                        this.$.table.items = function(params, callback) {
                            var val = that.$.rzsearch.value;
                            if (val.length > 5) {
                                var url = that.apiUrl+'/utils/get-cliente-from-razon-social/?index=' + params.index + '&count=' + params.count + '&razon_social=' + val;
                                var xhr = new XMLHttpRequest();
                                xhr.open('GET', url, true);
                                xhr.setRequestHeader("Authorization", "Token " + that.token)
                                xhr.onreadystatechange = function() {
                                    if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
                                    var response = JSON.parse(xhr.responseText);
                                    callback(response.data);
                                    that.$.table.size = response.size
                                }
                                };
                                xhr.send();
                            }
                        }        
                    }
                }
            },

            _clienteSelected: function() {
                var sidx = this.$.table.selection.selected()
                var that = this
                this.$.table.getItem(sidx, function(error, item) {
                    if (!error) {
                        that.fire("trineo-busca-xrz-cliente-selected", {cliente:item})
                    }
                })
            },

            open: function() {
                this.$.dialog.open();
            }
        });

        
    </script>
</dom-module>