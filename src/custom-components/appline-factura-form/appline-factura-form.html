<link rel="import" href="trineo-item-factv.html">
<link rel="import" href="trineo-item-head.html">
<link rel="import" href="trineo-servicio-dates.html">
<link rel="import" href="trineo-cliente.html">

<dom-module id="appline-factura-form">
  <template>
    <style include="shared-styles iron-flex iron-flex-alignment">
      :host {
        display: block;
      }

      [hidden] {
        display: none;
      }

      paper-card {
        width: 100%;
      }

      paper-spinner.miniwait {
        margin-top: 30px;
        width: 18px;
        height: 18px;
      }
      
      @media (max-width: 768px) {
        paper-input,
        vaadin-date-picker, paper-dropdown-menu,
        appline-idfiscal-input, trineo-servicio-dates {
          width: 100% !important;
          margin-right: 0 !important;
          max-width: 768px !important; 
        }
        
      }
      
      @media (max-width: 1440px) {
        paper-card#datos-comprobante paper-input,
        vaadin-date-picker,
        paper-dropdown-menu {
          max-width: 350px;
        }
      }
      
      vaadin-date-picker {
        padding-bottom: 8px;
      }
      
      .datos-header { 
        @apply(--paper-font-headline); 
      }

      .datos-location {
        font-size: 15px;
        vertical-align: middle;
      }

    </style>

<iron-ajax id="ajaxas" headers="[[getAuthHeader(userBackend.auth_token)]]" url="[[apiUrl]]/utils/ultimo-comprobante/" params="[[ultimoComprobanteParams]]" handle-as="json"
  last-response="{{ultimoComprobante}}"></iron-ajax>

<iron-ajax id="submitComprobanteAjax" method="POST" headers="[[getAuthorizationHeader()]]" url="[[apiUrl]]/ventas/" content-type="application/json" handle-as="json" on-response="_onSubmitResponse" on-error="_onSubmitError"></iron-ajax>
<iron-ajax id="aprobarComprobanteAjax" method="POST" url="[[apiUrl]]/utils/aprobar/" headers="[[getAuthHeader(userBackend.auth_token)]]" content-type="application/json" handle-as="json" on-response="_onAprobarResponse" on-error="_onAprobarError"></iron-ajax>



<form is="iron-form" id="form">  
<paper-card id="datos-comprobante">
  <div class="card-content">
    <div class="datos-header">Datos Comprobante
        <div class="datos-location">
          <span hidden$="[[!headerShowed]]"><b>Comprobante [[letraComprobante]]   --    N° [[pad_with_zeroes(ultimoComprobante.numero,8)]]</b></span>
        </div>
      </div>
    <div class="layout horizontal wrap center form-row">
      <div class="form-field col-3">
        <paper-dropdown-menu id="tipo-venta-el" name="tipo-venta" value="value" required label="Tipo de Venta" error-message="Seleccione un tipo de venta">
          <paper-listbox class="dropdown-content" selected="{{tipoVenta}}" attr-for-selected="value">
            <paper-item value="0">Productos</paper-item>
            <paper-item value="1">Servicios</paper-item>
            <paper-item value="2">Productos y Servicios</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
      <div class="form-field col-3">
        <paper-dropdown-menu required id="punto-venta-el" label="Punto de Venta" error-message="Seleccione un punto de venta">
          <paper-listbox id="puntoVentaSel" attr-for-selected="value" selected="{{puntoVentaSelected}}" class="dropdown-content">
            <template is="dom-repeat" items=[[userBackend.perfil_user.empresa.puntos_venta]] as=item index-as=index>
              <paper-item value="[[item.punto_venta]]">[[pad_with_zeroes(item.punto_venta,4)]]</paper-item>
            </template>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
      <div class="form-field col-3">
        <paper-dropdown-menu required id="tipo-comprobante" label="Tipo de comprobante" error-message="Seleccione un tipo de comprobante">
          <paper-listbox attr-for-selected="value" selected="{{tipoComprobante}}" class="dropdown-content">
            <paper-item value="FA">Factura</paper-item>
            <paper-item value="NC">Nota de crédito</paper-item>
            <paper-item value="ND">Nota de débito</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
      </div>
      <div class="form-field col-3">
        <vaadin-date-picker required id="fechaDatePicker" value={{fecha}} min="{{fechaMin}}" max="{{fechaMax}}" label="Fecha" error-message="Ingrese una fecha correcta"></vaadin-date-picker>
      </div>
    </div>
    <div class="layout horizontal wrap center justified">
        <trineo-cliente cliente={{cliente}} razon-social="{{cliente.razon_social}}"></trineo-cliente>  
    </div>
    <div class="layout horizontal wrap center justified">
    <trineo-servicio-dates fecha-c="[[fecha]]" 
        hidden$="[[!esServicio]]" 
        required="[[esServicio]]"
        fecha-desde="{{fechaServDesde}}"
        fecha-hasta="{{fechaServHasta}}"
        fecha-vencimiento="{{fechaVencimiento}}"></trineo-servicio-dates>
  </div>
  </div>
</paper-card>

<paper-card heading="Detalles">
  <div id="detalle" class="card-content">
    <trineo-item-head></trineo-item-head>
    <trineo-item-factv></trineo-item-factv>
    <paper-icon-button id="botonAgregarItem" icon="add" on-tap="agregarItem"></paper-icon-button>
    
    <paper-tooltip
      for="botonAgregarItem"
      position="right"
      offset="14">
      Agregar item al comprobante
    </paper-tooltip>
    

  </div>
</paper-card>
</form>

</template>
<script>
    Polymer({
      is: 'appline-factura-form',

      behaviors: [UtilsBehavior, DatesBehavior, AjaxBehavior, SettingsBehavior],
      //CALLBACK METHODS
      ready: function () {
        this.$.fechaDatePicker.i18n = this.get_i18n(); //From DatesBehavior

      },

      properties: {
        _discriminaIva: {
          type: Boolean,
          computed: "_discriminaIvaCompute(userBackend.perfil_user.empresa.categoria_iva, cliente.cond_iva)",
          observer: "_discriminaIvaChanged"
        },
        _asignaIva: {
          type: Boolean,
          computed: "_discriminaIvaCompute(userBackend.perfil_user.empresa.categoria_iva)",
          observer: "_asignaIvaChanged"
        },
        userBackend: Object,
        letraComprobante: {
          type: Boolean,
          computed: "_letraComprobanteCompute(userBackend.perfil_user.empresa.categoria_iva, cliente.cond_iva)"
        },
        tipoVenta: {
          type: String,
        },
        esServicio: {
          type: Boolean,
          computed: "_esServicioCompute(tipoVenta)",
          value: false
        },
        tipoComprobante: String,
        fecha: {
          type: String,
          value: function () {
            return moment().format("YYYY-MM-DD")
          }
        },
        fechaMin: {
          type: String,
          computed: "_fechaMinFunc(tipoVenta, ultimoComprobante.fecha)"
        },
        fechaMax: {
          type: String,
          computed: "_fechaMaxFunc(tipoVenta)"
        },
        fechaServDesde: String,
        fechaServHasta: String,
        fechaVencimiento: String,
        cliente: Object,
        ultimoComprobante: {
          type: Object
        },
        ultimoComprobanteParams: {
          type: Object,
          computed: "_ultimoComprobanteParamsCompute(puntoVentaSelected, tipoComprobante, letraComprobante)"
        },
        headerShowed: {
          type: Boolean,
          value: false
        },
        total: {
          type: Number,
          observer: "_totalChanged"
        },
        puntoVentaSelected: String,
        clienteAjaxFlight: Boolean,
      },

      listeners: {
        "item-changed": "handleItemChanged"
      },

      //Observer's

      observers: [
        "_encabezadoChanged(puntoVentaSelected, tipoComprobante, letraComprobante)"
      ],

      _encabezadoChanged: function (puntoVentaSelected, tipoComprobante, letraComprobante) {
        if (puntoVentaSelected != undefined && tipoComprobante != undefined && letraComprobante!= undefined) {
          this.$.ajaxas.headers = {Authorization: "Token "+this.userBackend.auth_token}
          this.$.ajaxas.auto=true
          this.headerShowed = true
        }
        else {
          this.headerShowed = false
        }
      },

      _totalChanged: function(val) {
          //if (this.userBackend && this.userBackend.perfil_user.empresa.categoria_iva == 1 && val<1000) {
            //this.$.direccion.disabled=true
            //this.$.direccion.required=false
            //this.$.direccion.value="No es necesario"
          //}
          //else {
            //this.$.direccion.disabled=false
            //this.$.direccion.required=true
            //if (this.cliente) {
            //  this.$.direccion.value=this.cliente.domicilio.direccion
            //}
            //else {this.$.direccion.value=""}
          //}
        
      },

      _discriminaIvaChanged: function (val) {
          var items=Polymer.dom(this.root).querySelectorAll('trineo-item-factv')
          for (i=0; i<items.length; i++) {
              items[i].discriminaIva = val
        }
        this._totalChanged(this.total)
      },
      _asignaIvaChanged: function (val) {
          var items=Polymer.dom(this.root).querySelectorAll('trineo-item-factv')
          for (i=0; i<items.length; i++) {
              items[i].asignaIva = val
        }
        this._totalChanged(this.total)
      },

      //Compute's
      _fechaMinFunc: function (tipoVenta, fechault) {
        var hoy = moment()
        var feu = moment(fechault)
        if (tipoVenta == 0) {
          if (feu > hoy.subtract(5, 'days')) {
            return feu.format("YYYY-MM-DD")
          }
          return hoy.format("YYYY-MM-DD")
        } else {
          if (feu > hoy.subtract(10, 'days')) {
            return feu.format("YYYY-MM-DD")
          }
          return hoy.format("YYYY-MM-DD")
        }
      },

      _fechaMaxFunc: function (tipoVenta) {
        var hoy = moment()
        if (tipoVenta == 0) {
          return min = hoy.add(5, 'days').format("YYYY-MM-DD")
        }
        return min = hoy.add(10, 'days').format("YYYY-MM-DD")
      },

      _ultimoComprobanteParamsCompute: function (puntoVentaSelected, tipoComprobante, letraComprobante) {
          return { "punto_venta": puntoVentaSelected, "tipo_comprobante": tipoComprobante+letraComprobante }
      },

      _discriminaIvaCompute: function(categoria, con_iva_cliente) {
        if (categoria==0 && con_iva_cliente !=2) {
          return true
        }
        return false
      },

      _asignaIvaCompute: function(categoria) {
        if (categoria==0) {
          return true
        }
        return false
      },

      _letraComprobanteCompute: function(categoria, con_iva_cliente) {
        if (categoria == 1) {
          return "C"
        }
        else {
          if (con_iva_cliente == 0) {
            return "A"
          }
          return "B" 
        }
      },

      _esServicioCompute: function(tv) {
        if (tv == "1" || tv == "2") {
          return true
        }
        return false
      },

      _parseInt: function (val) {
        return parseInt(val);
      },

      agregarItem: function () {
        var el = document.createElement('trineo-item-factv');
        switch (this.letraComprobante) {
            case "A":
              el.discriminaIva = true
              el.asignaIva = true
              break;
            case "B":
              el.discriminaIva = false
              el.asignaIva = true
              break;
            case "C":
              el.discriminaIva = false
              el.asignaIva = false
              break;
          }
        this.$.detalle.insertBefore(el, this.$.botonAgregarItem);
      },

      handleItemChanged: function (e) {
        this.actualizarTotales();
      },

      actualizarTotales: function () {
        var neto = 0
        var iva105 = 0
        var iva21 = 0
        var iva27 = 0
        var items = Polymer.dom(this.root).querySelectorAll('trineo-item-factv')
        for (i = 0; i < items.length; i++) {
          var item = items[i]
          neto = neto + Number(item.neto)
          switch (item.alicIva) {
            case "IV105":
              iva105 = iva105 + Number(item.valorIva);
              break;
            case "IVA21":
              iva21 = iva21 + Number(item.valorIva);
              break;
            case "IVA27":
              iva27 = iva27 + Number(item.valorIva);
              break;
          }

          this.total = (neto + iva105 + iva21 + iva27).toFixed(2)

          this.fire("trineo-actualizar-totales-comprobante", {neto: neto.toFixed(2), iva105:iva105.toFixed(2), iva21:iva21.toFixed(2), iva27:iva27.toFixed(2), total:this.total})
        }
      },
      clear: function() {
        this.$.ajaxas.auto=false; // Ajax del ultimo comprobante saco auto
        this.tipoVenta = this.puntoVentaSelected = this.tipoComprobante = this.cliente = this.ultimoComprobante = null
        var items=Polymer.dom(this.root).querySelectorAll('trineo-item-factv')
        for (i = 0; i < items.length; i++) {
          Polymer.dom(items[i].parentNode).removeChild(items[i])  
        }
        this.agregarItem();
        this.actualizarTotales();
      },

      submit: function() {
        //Submit del formulario, no tradicional, simplemente valida y hace una post al API rest
        if(this.$.form.validate()){
          var patt = new RegExp("(0+-0+-0+)|(0+)") //Validar que haya un cliente que no sea consumidor final si es B
          if (this.letraComprobante != 'C' && this.total > 1000 && patt.test(this.cuitDni)) {
            alert("No se permite en facturas mayores a $1000 que el cliente no sea identificado.")
          }
          else {
            this.fire("open-wait", {mensaje: "Aprobando..."})
            //Armar el objeto para hacer el post
            var fact = {}
            fact['tipo']=this.tipoComprobante+this.letraComprobante
            fact['fecha']=this.fecha
            fact['empresa'] = this.userBackend.perfil_user.empresa.id
            fact['punto_venta'] = this.puntoVentaSelected
            fact['tipo_venta'] = this.tipoVenta
            if (this.tipoVenta == "1" || this.tipoVenta == "2") {
            fact['serv_desde'] = this.fechaServDesde
            fact['serv_hasta'] = this.fechaServHasta
            fact['venc_pago'] = this.fechaVencimiento
            }           
            fact['cliente'] = this.cliente
            fact['items']=[]
            var items = Polymer.dom(this.root).querySelectorAll('trineo-item-factv')
            for (i=0; i<items.length; i++) {
              var obj = {cantidad:items[i].cantidad,
                descripcion:items[i].descripcion,
                precio_unitario:items[i]._precioUnitario,
                iva:items[i].alicIva,
                tipo: 1}
              fact['items'].push(obj)
            }
            this.$.submitComprobanteAjax.body = fact
            this.$.submitComprobanteAjax.generateRequest()
          }
        }
      },

      _onSubmitResponse: function(ev) {
        var id = ev.detail.xhr.response.id
        this.$.aprobarComprobanteAjax.body = {comprobante:id}
        this.$.aprobarComprobanteAjax.generateRequest()
      },

      _onSubmitError: function(ev) {
        this.fire("close-wait")
        this.fire("error-general")
      },

      _onAprobarResponse: function(ev) {
        this.fire("close-wait")
        var resp = ev.detail.xhr.response
        if (resp.aprobado) {
          this.clear();
          this.fire("comprobante-aprobado", {data:resp.data});
        }
        else {
          this.fire("comprobante-no-aprobado", {data:resp.data})
        }
      },

      _onAprobarError: function(ev) {
        this.fire("close-wait")
        this.fire("error-general")
      }
    });
  </script>
</dom-module>