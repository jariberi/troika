<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="../appline-password-input/appline-password-input.html">
<link rel="import" href="../appline-idfiscal-input/appline-idfiscal-input.html">
<link rel="import" href="../appline-error-msg/appline-error-msg.html">

<link rel="import" href="../../behaviors/ajax-behavior.html">




<dom-module id="appline-login-form">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                background-color: var(--primary-color);
                width: 100vw;
                height: 100vh;
            }
            paper-input, paper-dropdown-menu {
                width: 100%;
            }

            paper-dialog {
                width: 300px;
                padding: 20px;
            }
            paper-button {
                width: 90%;
                margin: 5%;
            }
            paper-button.link {
                width: 80%;
                margin: 10%;
                color: #3F51B5;
            }
            paper-button.link:hover {
                background-color: rgba(48,63,159,0.1);
                color: #303F9F;
            }
            paper-button.link:disabled {
                color: rgba(48,63,159,0.1);
                background: none;
            }

            
        </style>

        <iron-ajax id="loginAjax" url="[[loginUrl]]" handle-as="json" method="POST" content-type="application/x-www-form-urlencoded" 
            body="username=[[username]]&password=[[password]]" last-response="{{userBackend}}" on-error="_loginError" on-response="_loginResponse"></iron-ajax>
        <iron-ajax id="createUserAjax" url="[[createUrl]]" content-type="application/x-www-form-urlencoded" handle-as="json" method="POST" 
            body="username=[[username]]&password=[[password]]&razon_social=[[razon_social]]&cuit=[[cuit]]&categoria_iva=[[categoriaIva]]" last-response="{{userBackend}}"
            on-error="_createError" on-response="_createResponse"></iron-ajax>
        
        <form is="iron-form" id="loginForm">
        <paper-dialog id="loginDialog" modal>
            <h2>Login</h2>
            <paper-dialog-scrollable>
                <div class="layout vertical centered">
                    <paper-button id="usunue" class="link" on-tap="_toggleLogin">Soy un usuario nuevo</paper-button>
                    <gold-email-input required label="Email" error-message="Ingrese un mail válido" value="{{username}}"></gold-email-input>
                    <paper-input required error-message="Ingrese contraseña" label="Contraseña" type="password" value="{{password}}"></paper-input>
                    <appline-error-msg hidden$="[[!errorLoginMsg]]" message="[[errorLoginMsg]]" id="errorLogin"></appline-error-msg>
                    <paper-button id="logbtn" on-tap="_login" raised><span id="logspa">Login!</span><paper-spinner id="logspi"></paper-spinner></paper-button>
                </div>
            </paper-dialog-scrollable>
        </paper-dialog>
        </form>

        <form is="iron-form" id="createUserForm">
        <paper-dialog id="newUserDialog" modal>
            <h2>Nuevo usuario</h2>
            <paper-dialog-scrollable>
                <div class="layout vertical centered">
                    <paper-button id="usuvie" class="link" on-tap="_toggleLogin">Ya estoy registrado</paper-button>
                    <gold-email-input required label="Email" error-message="Ingrese un mail válido" value="{{username}}"></gold-email-input>
                    <appline-password-input id="passin" password={{password}} required></appline-password-input>
                    <appline-idfiscal-input required only-cuit id="cuitDni" label="Cuit" value="{{cuit}}" error-message="Ingrese CUIT válido"></appline-idfiscal-input>
                    <paper-input required label="Razon Social" value="{{razon_social}}" error-message="Ingrese razón social"></paper-input>
                    <paper-dropdown-menu name="categoria-iva" value="value" required label="Categoria IVA" error-message="Seleccione una categoria de IVA">
                        <paper-listbox class="dropdown-content" selected="{{categoriaIva}}" attr-for-selected="value">
                            <paper-item value="0">Responsable Inscripto</paper-item>
                            <paper-item value="1">Monotributo</paper-item>
                        </paper-listbox>
                    </paper-dropdown-menu>
                    <appline-error-msg hidden$=[[!errorCreateMsg]] message="[[errorCreateMsg]]" id="errorCreate"></appline-error-msg>
                    <paper-button id="crebtn" on-tap="_createUser" raised><span id="crespa">Crear!</span><paper-spinner id="crespi"></paper-spinner></paper-button>
                </div>
            </paper-dialog-scrollable>
        </paper-dialog>
        </form>

    </template>
<script>
        Polymer({
            is: 'appline-login-form',

            properties: {
                loginUrl: String,
                createUrl: String,
                username: String,
                password: String,
                razon_social: String,
                cuit: String,
                urlAuth: String,
                loggedIn: {
                    type: Boolean,
                    value: true,
                    computed: "_loggedInCompute(userBackend)",
                    observer: "_loggedInChanged"
                },
                userBackend: {
                    type: Object,
                    notify: true,
                    reflectToAttribute: true,
                },
                errorCreateMsg: String,
                errorLoginMsg: String
            },

            behaviors: [AjaxBehavior],

            _loggedInCompute: function (userBackend) {
                return !!userBackend
            },

            _loggedInChanged: function (val, old) {
                if(val==false) {
                    this.open();
                }
                else {
                    if (this.$.loginDialog.opened) {this.$.loginDialog.close();}
                    if (this.$.newUserDialog.opened) {this.$.newUserDialog.close();}
                }
            },

            open: function() {
                this.$.loginDialog.open();
            },

            _login: function (e) {
                if(this.$.loginForm.validate()) {
                    this.$.logspi.active=true
                    this.$.logspa.setAttribute("hidden", true)
                    this.$.loginAjax.generateRequest();
                    this.$.usunue.disabled=true
                    this.$.logbtn.disabled=true
                }
            },

            _createUser: function() {
                if(this.$.createUserForm.validate()) {
                    this.$.crespi.active=true
                    this.$.crespa.setAttribute("hidden", true)
                    this.$.createUserAjax.generateRequest();
                    this.$.usuvie.disabled=true
                    this.$.crebtn.disabled=true
                }
            },

            _toggleLogin: function() {
                if (this.$.loginDialog.opened) {
                    this.$.loginDialog.close();
                    this.$.newUserDialog.open();
                }
                else {
                    this.$.newUserDialog.close();
                    this.$.loginDialog.open();
                }
            },
            _loginError: function(e,r) {
                var status = r.request.xhr.status
                if (status == 401) {
                    this.errorLoginMsg = "Usuario o contraseña incorrectos."
                } else {
                    this.errorLoginMsg = "Error general. Reintente en unos minutos."
                }
                this.$.logspi.active=false
                this.$.logspa.removeAttribute("hidden")
                this.$.usunue.disabled=false
                this.$.logbtn.disabled=false
            },

            _loginResponse: function() {
                this.username = ""
                this.password = ""
                this.$.usunue.disabled=false
                this.$.logbtn.disabled=false
                this.$.logspi.active=false
                this.$.logspa.removeAttribute("hidden")
            },

            _createError: function(e,r) {
                var status = r.request.xhr.status
                if (status == 409) {
                    this.errorCreateMsg = "El email o el CUIT ya existen."
                } else {
                    this.errorCreateMsg = "Error general. Reintente en unos minutos."
                }
                this.$.crespi.active=false
                this.$.crespa.removeAttribute("hidden")
                this.$.usuvie.disabled=false
                this.$.crebtn.disabled=false
            },
            _createResponse: function() {
                this.password = this.razon_social = this.cuit = this.username = ""
                this.categoriaIva = undefined
                this.$.passin.clear()
                this.$.usuvie.disabled=false
                this.$.crebtn.disabled=false
                this.$.crespi.active=false
                this.$.crespa.removeAttribute("hidden")
            }
        });
    </script>
</dom-module>